<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="gandhi-taha">
    
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Misconfigured LAPS - Notes</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Background", url: "#_top", children: [
          ]},
          {title: "How to check for existence of LAPS", url: "#how-to-check-for-existence-of-laps", children: [
          ]},
          {title: "How to check who can view the passwords in cleartext", url: "#how-to-check-who-can-view-the-passwords-in-cleartext", children: [
          ]},
          {title: "References", url: "#references", children: [
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../misconfigured_read_only_domain_controller/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../misconfigured_read_only_domain_controller/" class="btn btn-xs btn-link">
        Misconfigured RODC
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../aseproasting/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../aseproasting/" class="btn btn-xs btn-link">
        AS-REP roasting
      </a>
    </div>
    
  </div>

    

    <h2 id="background">Background<a class="headerlink" href="#background" title="Permanent link">#</a></h2>
<p>Local Administrator Password Solution (LAPS) is a great AD feature that in a secure way mange local administrator passwords. It offers a way to prevent the reuse one the same password on multiple machines. LAPS sets a complex and unique password for every computer in the domain. Thus removing the possibility for lateral movement once a local admin password has been found. Before LAPS local administrator passwords were often managed through Group Policy Preferences, which was a terrible solution (as can be seen in the chapter on GPP). They were sometimes set using scripts found in the SYSVOL, again exposing them to everyone with access to the SYSVOL. Another common options was to use third party products, Thycotic, CyberArk, Liberman, etc.</p>
<p>To use LAPS the administrator must install LAPS on the management server. This will extend the AD schema and add two new attributes: <code>ms-McsAdmPwd</code> and <code>ms-Mcs-AdmPwdExpirationTime</code>.  </p>
<p><code>ms-McsAdmPwd</code> contains the local administrator password in cleartext.<br />
<code>ms-Mcs-AdmPwdExpirationTime</code> contains the time and date when the password expires.</p>
<p>A LAPS agent will need to be running on each computer. It is this agent that changes the password.</p>
<p>If the access control of the attribute is incorrectly configured it can allow too many users to have read access to the password attribute, thus allowing a user to read the local administrator password of multiple computers.</p>
<p>Even if your user is not allowed to read the password it is still possible to enumerate who can read the password. Thos users are then attrctive targets.  </p>
<p>Normally not even the computer itself should have read-access to the attributes. Only be able to update those attributes, but not read them.</p>
<h2 id="how-to-check-for-existence-of-laps">How to check for existence of LAPS<a class="headerlink" href="#how-to-check-for-existence-of-laps" title="Permanent link">#</a></h2>
<p>To check if LAPS is running on your computer you can check for the following dll <code>AdmPwd.dll</code>, in its default location <code>C:\Program Files\LAPS\CSE\</code>.</p>
<p>You can check if the schema has been updated with the new attributes: <code>Get-ADObject 'CN=ms-mcs-admpwd, CN=Schema, CN=configuration, DC=evilcorp, DC=local'</code>
If it returns data it has the updated schema, otherwise you will get an error.</p>
<p>The attribute <code>ms-Mcs-AdmPwdExpirationTime</code> is readible to everyone. So every computer that is administrated using LAPS will have this attribute. It is therefore possible to enumerate all computers that are nog included in LAPS.</p>
<p>Using the PowerSploit command <code>get-DomainGpo -Identity "*LAPS*"</code>.</p>
<p>I haven't tested this one. But it should list </p>
<pre><code class="PowerShell">Get-NetOU | 
    Get-ObjectAcl -ResolveGUIDs | 
    Where-Object {
        ($_.ObjectType -like 'ms-Mcs-AdmPwd') -and 
        ($_.ActiveDirectoryRights -match 'ReadProperty')
    } | ForEach-Object {
        $_ | Add-Member NoteProperty 'IdentitySID' $(Convert-NameToSid $_.IdentityReference).SID;
        $_
    }
</code></pre>

<p>Using bloodhound this query can be used:</p>
<pre><code>MATCH (u) -[:ReadLAPSPassword]-(c:Computer) return u;
</code></pre>

<h2 id="how-to-check-who-can-view-the-passwords-in-cleartext">How to check who can view the passwords in cleartext<a class="headerlink" href="#how-to-check-who-can-view-the-passwords-in-cleartext" title="Permanent link">#</a></h2>
<p><code>Get-NetOU -FullData |</code></p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">#</a></h2>
<p>https://rastamouse.me/2018/03/laps---part-1/</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../misconfigured_read_only_domain_controller/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../misconfigured_read_only_domain_controller/" class="btn btn-xs btn-link">
        Misconfigured RODC
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../aseproasting/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../aseproasting/" class="btn btn-xs btn-link">
        AS-REP roasting
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/gandhi-taha/edit/master/docs/attacking_active_directory_domain/active_directory_privilege_escalation/check_for_misconfigured_laps.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>